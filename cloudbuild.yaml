name: Deploy to Cloud Run
on:
  push:
    branches:
      - main
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set env
      run: echo "RELEASE_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
        
    - name: 'gcr.io/cloud-builders/docker'
      id: Build
      run: build -t asia.gcr.io/$REPO_NAME:$RELEASE_VERSION
    
    - name: 'gcr.io/cloud-builders/docker'
      id: Push
      run: push asia.gcr.io/$REPO_NAME:$RELEASE_VERSION
    
    - name: 'gcr.io/cloud-builders/gcloud'
      id : Deploy to Cloud Run
      run: run deploy healthy-salad --image asia.gcr.io/$REPO_NAME:$RELEASE_VERSION --region asia-southeast1 --platform managed --allow-unauthenticated
